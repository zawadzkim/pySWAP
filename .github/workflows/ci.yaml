name: Continuous Integration

on:
  push:
    branches: [dev]
    paths-ignore:
      - "docs/**"
      - "*.md"
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - "docs/**"
      - "*.md"

permissions:
  contents: read
  packages: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tests-passed: ${{ steps.test.outcome }}
      build-success: ${{ steps.build.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.2
        with:
          pixi-version: v0.59.0
          cache: true

      - name: Extract version from pyproject.toml
        id: version
        run: |
          version=$(pixi run -e dev python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"

      - name: Run tests
        id: test
        run: |
          pixi run -e dev pytest tests/ -v --cov=pyswap --cov-report=term --cov-report=xml
          echo "Tests completed successfully"

      - name: Run linting
        run: |
          pixi run -e dev ruff check .
          echo "Linting passed"

      - name: Build package
        id: build
        run: |
          pixi run -e dev python -m build
          echo "Package built successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: package-dist-${{ github.sha }}
          path: dist/
          retention-days: 7

      - name: Upload coverage reports
        uses: actions/upload-artifact@v5
        with:
          name: coverage-${{ github.sha }}
          path: coverage.xml
          retention-days: 7